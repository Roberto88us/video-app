<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rob Video Call App</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Ctext y='50' font-size='48'%3E%F0%9F%93%BA%3C/text%3E%3C/svg%3E">
<link rel="preconnect" href="https://unpkg.com">
<style>
  :root { --bg:#0b0f14; --card:#121923; --muted:#8aa0b2; --text:#eaf2f9; --accent:#4da3ff; }
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:14px 0 10px}
  .brand{font-weight:700;letter-spacing:.2px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .card{background:var(--card);border:1px solid #1f2a38;border-radius:16px;padding:10px;position:relative;min-height:260px}
  video{width:100%;height:58vh;min-height:260px;background:#0a0a0a;border-radius:12px;object-fit:cover}
  .videos{grid-column:1/-1}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;background:#0f1621;border:1px solid #1f2a38;color:var(--text);text-decoration:none}
  button.pill{cursor:pointer}
  .pill[disabled]{opacity:.6;cursor:not-allowed}
  .small{font-size:.9rem;color:var(--muted)}
  .linkbox{display:flex;gap:8px;align-items:center;background:#0f1621;border:1px solid #1f2a38;border-radius:12px;padding:10px 12px;overflow:auto}
  .badge{display:inline-flex;align-items:center;gap:6px;background:#0f2033;border:1px solid #1f2a38;color:#c8e2ff;padding:6px 10px;border-radius:999px;font-size:.85rem}
  /* New classes extracted from inline styles */
  .video-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;margin:10px}
  .inner-card{min-height:200px;margin:10px}
  .row-controls{margin:4px 0 10px}
  .push-right{margin-left:auto}
  .divider{border:0;border-top:1px solid #1f2a38;margin:12px 0}
  .mb-6{margin-bottom:6px}
  .nowrap{white-space:nowrap}
  .section-title{margin:10px 10px 6px;text-align:center}
  .hint{position:absolute;inset:auto 10px 10px 10px;color:#c9d8e0;font-size:.9rem;opacity:.9}
  .status{font-variant-numeric:tabular-nums}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#07101a;color:#e8f2ff;border:1px solid #15314e;padding:10px 14px;border-radius:12px;display:none}
  .footer{margin-top:12px;color:var(--muted);font-size:.9rem}
  @media (max-width:920px){ .grid{grid-template-columns:1fr} video{height:50vh} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">Quick Video Call</div>
    <div class="row small">
      <span class="badge" id="roleBadge">Role: <strong id="roleText">Host</strong></span>
      <span class="badge">Status: <span class="status" id="statusText">Initializing‚Ä¶</span></span>
      <span class="badge">ID: <span class="status" id="idText">‚Äî</span></span>
    </div>
  </header>

  <div class="grid">
    <div class="card videos">
      <div id="videoGrid" class="video-grid"></div>
    </div>

    <div class="card">
      <div class="row row-controls">
        <button class="pill push-right" id="btnStart" type="button">‚ñ∂Ô∏è Join / Start</button>
        <button class="pill" id="btnMic" type="button">üéôÔ∏è Mute</button>
        <button class="pill" id="btnCam" type="button">üé• Camera Off</button>
        <button class="pill" id="btnHang" type="button">‚õî End Call</button>
      </div>
      <div class="small">Tip: Click <strong>Join / Start</strong> if autoplay is blocked or you arrived via an invite link.</div>
      <hr class="divider">
      <div class="small mb-6">Invite Link</div>
      <div class="linkbox">
        <code id="inviteLink" class="nowrap"></code>
        <button class="pill" id="btnCopy" type="button">üìã Copy</button>
      </div>
      <div class="footer">
        Uses WebRTC + PeerJS cloud signaling. Keep this tab open during the call.
      </div>
    </div>

    <div class="card">
      <div class="small section-title">Connection Info</div>
      <div class="row"><span class="badge">Mode: <span id="modeText">Waiting</span></span></div>
      <div class="small">
        If you opened this page normally, you‚Äôre the <strong>Host</strong>. Send the invite link to the other person.
        If you opened it with <code>?call=XYZ</code>, you‚Äôre the <strong>Guest</strong> and it will dial the host.
      </div>
      <div class="small">
        Works peer-to-peer when possible. If either side has strict firewalls, try a different network.
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script>
(async () => {
  // ------ Helpers ------
  const $ = (id) => document.getElementById(id);
  const toast = (msg) => { const t=$('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(window.__toast); window.__toast=setTimeout(()=>t.style.display='none',2200); };
  const q = new URLSearchParams(location.search);
  const isGuest = q.has('call');
  const callTargetId = q.get('call') || '';
  const roleTextEl = $('roleText'), statusText = $('statusText'), idText = $('idText'), modeText = $('modeText');
  roleTextEl.textContent = isGuest ? 'Guest' : 'Host';
  $('roleBadge').style.background = isGuest ? '#1a2a12' : '#0f2033';

  // ------ Media (camera/mic) ------
  let localStream = null;
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: { width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
    });
    $('localVideo').srcObject = localStream;
    await $('localVideo').play().catch(()=>{});
    statusText.textContent = 'Devices ready';
  } catch (e) {
    statusText.textContent = 'Camera/Mic blocked';
    alert('Please allow camera and microphone to join the call.');
    console.error(e);
    return;
  }

  // ------ PeerJS (signaling) ------
  const randomId = () => 'user-' + ([...crypto.getRandomValues(new Uint8Array(8))].map(b=>b.toString(16).padStart(2,'0')).join(''));
  const myId = isGuest ? undefined : randomId();
  let myPeerId = undefined;

  const peer = new Peer(myId, {
    host: '0.peerjs.com', port: 443, secure: true,
    config: {
      iceServers: [
        { urls: ['stun:stun.l.google.com:19302','stun:stun1.l.google.com:19302'] },
        { urls: ['stun:stun.cloudflare.com:3478'] },
        { urls: ['stun:stun.stunprotocol.org:3478'] }
        // To improve connectivity behind strict NATs, add a TURN server here:
        // { urls: 'turn:YOUR_TURN_HOST:3478', username: 'YOUR_USER', credential: 'YOUR_PASSWORD' }
      ]
      // If you add a TURN server and want to force relay, you can also set:
      // iceTransportPolicy: 'all' // or 'relay'
    },
    debug: 1
  });

  // Multi-party state
  const mediaCalls = new Map(); // peerId -> MediaConnection
  const videoEls = new Map();   // peerId|'self' -> HTMLVideoElement
  const dataConns = new Map();  // peerId -> DataConnection (host only)
  const participants = new Set(); // host tracks, guests read from roster
  let hostDataConn = null; // guest -> host data channel
  let ended = false;

  // Helpers for dynamic tiles
  const videoGrid = document.getElementById('videoGrid');
  function sanitizeId(id){ return String(id||'').replace(/[^a-zA-Z0-9_-]/g,''); }
  function ensureTile(tileId, label, muted=false){
    if (videoEls.has(tileId)) return videoEls.get(tileId);
    const container = document.createElement('div');
    container.className = 'card inner-card video-tile';
    const vid = document.createElement('video');
    vid.setAttribute('playsinline','');
    if (muted) vid.muted = true;
    vid.autoplay = false; // we will call play() in JS
    vid.style.width = '100%';
    const hint = document.createElement('div');
    hint.className = 'hint';
    hint.textContent = label;
    container.appendChild(vid);
    container.appendChild(hint);
    videoGrid.appendChild(container);
    videoEls.set(tileId, vid);
    return vid;
  }
  async function attachStreamToTile(tileId, label, stream, muted=false){
    const vid = ensureTile(tileId, label, muted);
    try {
      if (vid.srcObject !== stream) vid.srcObject = stream;
      await vid.play().catch(()=>{});
    } catch {}
  }

  const updateInvite = (pid) => {
    const url = new URL(location.href);
    url.searchParams.set('call', pid);
    $('inviteLink').textContent = url.toString();
  };

  peer.on('open', (id) => {
    myPeerId = id;
    idText.textContent = id;
    statusText.textContent = 'Ready';
    if (!isGuest) {
      updateInvite(id);
      modeText.textContent = 'Hosting (waiting for guests)';
      // Host: track self and broadcast roster when guests connect
      participants.add(id);
    } else {
      modeText.textContent = 'Guest (connecting to host)';
      // Guest: open data channel to host for roster
      hostDataConn = peer.connect(callTargetId, { reliable: true });
      hostDataConn.on('open', () => {
        hostDataConn.send({ type: 'join', id });
      });
      hostDataConn.on('data', (msg) => {
        if (!msg || typeof msg !== 'object') return;
        if (msg.type === 'roster' && Array.isArray(msg.ids)) {
          // Call everyone listed except self
          msg.ids.filter(pid => pid && pid !== myPeerId).forEach(pid => ensureOutgoingCall(pid));
        }
      });
      hostDataConn.on('close', () => { console.warn('Host data connection closed'); });
      hostDataConn.on('error', (e) => { console.error('Host data error', e); });
    }
  });

  peer.on('error', (err) => {
    console.error(err);
    statusText.textContent = 'Error';
    toast('Connection error. Refresh and try again.');
  });

  // ------ Media calls: handle incoming ------
  peer.on('call', (call) => {
    if (ended) return;
    const pid = call.peer;
    if (mediaCalls.has(pid)) {
      // Already have a call; still answer to ensure flow, but keep map to latest
      try { call.answer(localStream); } catch {}
    } else {
      try { call.answer(localStream); } catch {}
    }
    wireMediaCall(pid, call);
  });

  // ------ Host: accept data channels; track roster and broadcast ------
  peer.on('connection', (conn) => {
    if (ended) return;
    if (isGuest) return; // only host coordinates roster
    dataConns.set(conn.peer, conn);
    conn.on('data', (msg) => {
      if (!msg || typeof msg !== 'object') return;
      if (msg.type === 'join') {
        participants.add(conn.peer);
        broadcastRoster();
      }
    });
    conn.on('close', () => {
      participants.delete(conn.peer);
      dataConns.delete(conn.peer);
      broadcastRoster();
    });
    conn.on('error', () => {
      // Keep going; next broadcast will refresh
    });
    // Send initial roster
    broadcastRoster();
  });

  function broadcastRoster(){
    if (isGuest) return;
    const ids = Array.from(participants);
    dataConns.forEach(dc => { try { dc.send({ type:'roster', ids }); } catch {} });
  }

  // ------ Outgoing media calls to a specific peer ------
  function ensureOutgoingCall(pid){
    if (pid === myPeerId) return;
    if (mediaCalls.has(pid)) return;
    try {
      const call = peer.call(pid, localStream, { metadata: { from: isGuest ? 'guest' : 'host' } });
      if (!call) return;
      wireMediaCall(pid, call);
    } catch (e) {
      console.error('Call start error to', pid, e);
    }
  }

  // Shared media call wiring
  function wireMediaCall(pid, call){
    // Keep latest call reference
    mediaCalls.set(pid, call);
    call.on('stream', async (remoteStream) => {
      await attachStreamToTile(pid, pid, remoteStream, false);
      statusText.textContent = 'Connected';
    });
    // Diagnostics
    try {
      const pc = call.peerConnection || call._pc || call._peerConnection;
      if (pc) {
        pc.addEventListener('iceconnectionstatechange', () => {
          const s = pc.iceConnectionState;
          console.log('[ICE]', pid, 'iceConnectionState:', s);
        });
      }
    } catch {}
    call.on('close', () => {
      mediaCalls.delete(pid);
    });
    call.on('error', (e) => {
      console.error('Call error with', pid, e);
    });
  }

  function cleanupCall() {
    mediaCalls.forEach((c) => { try { c.close(); } catch {} });
    mediaCalls.clear();
  }

  function endEverything() {
    ended = true;
    cleanupCall();
    try { peer.destroy(); } catch {}
    statusText.textContent = 'Ended';
  }

  // ------ Controls ------
  let micOn = true, camOn = true;

  $('btnMic').onclick = () => {
    micOn = !micOn;
    localStream.getAudioTracks().forEach(t => t.enabled = micOn);
    $('btnMic').textContent = micOn ? 'üéôÔ∏è Mute' : 'üîá Unmute';
  };
  $('btnCam').onclick = () => {
    camOn = !camOn;
    localStream.getVideoTracks().forEach(t => t.enabled = camOn);
    $('btnCam').textContent = camOn ? 'üé• Camera Off' : 'üì∑ Camera On';
  };
  $('btnHang').onclick = () => { endEverything(); toast('You left the call'); };

  $('btnCopy').onclick = async () => {
    try { await navigator.clipboard.writeText($('inviteLink').textContent); toast('Invite link copied'); }
    catch { toast('Copy failed'); }
  };

  $('btnStart').onclick = () => {
    // Kick autoplay on all tiles
    videoEls.forEach(v => v.play().catch(()=>{}));
    toast('Starting‚Ä¶');
  };

  // Warn on unload while connected
  window.addEventListener('beforeunload', (e) => {
    if (mediaCalls.size > 0) { e.preventDefault(); e.returnValue = ''; }
  });

  // Add local video tile immediately
  await attachStreamToTile('self', 'You', localStream, true);
})();
</script>
</body>
</html>
